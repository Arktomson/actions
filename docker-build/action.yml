name: 'Docker Builder'
description: 'æ„å»ºå’Œæ¨é€ Docker é•œåƒ'

branding:
  icon: 'layers'
  color: 'blue'

inputs:
  image_name:
    description: 'é•œåƒåç§°'
    required: true
  tag:
    description: 'é•œåƒæ ‡ç­¾'
    required: false
    default: 'latest'
  registry:
    description: 'Docker æ³¨å†Œè¡¨ (docker.io, ghcr.io, etc.)'
    required: false
    default: 'docker.io'
  username:
    description: 'æ³¨å†Œè¡¨ç”¨æˆ·å'
    required: false
  password:
    description: 'æ³¨å†Œè¡¨å¯†ç æˆ–è®¿é—®ä»¤ç‰Œ'
    required: false
  dockerfile:
    description: 'Dockerfile è·¯å¾„'
    required: false
    default: './Dockerfile'
  context:
    description: 'æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„'
    required: false
    default: '.'
  build_args:
    description: 'æ„å»ºå‚æ•° (æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼: KEY=VALUE)'
    required: false
  platforms:
    description: 'ç›®æ ‡å¹³å° (linux/amd64,linux/arm64)'
    required: false
    default: 'linux/amd64'
  push:
    description: 'æ˜¯å¦æ¨é€é•œåƒ'
    required: false
    default: 'true'
  cache_from:
    description: 'ç¼“å­˜æ¥æºé•œåƒ'
    required: false
  cache_to:
    description: 'ç¼“å­˜ç›®æ ‡'
    required: false
  labels:
    description: 'é•œåƒæ ‡ç­¾ (æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼: KEY=VALUE)'
    required: false

outputs:
  image_digest:
    description: 'é•œåƒæ‘˜è¦'
  image_url:
    description: 'é•œåƒ URL'
  image_size:
    description: 'é•œåƒå¤§å°'

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Registry
      if: inputs.username != '' && inputs.password != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}
        
    - name: Prepare build args
      id: build_args
      shell: bash
      run: |
        BUILD_ARGS=""
        if [[ -n "${{ inputs.build_args }}" ]]; then
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              BUILD_ARGS="$BUILD_ARGS --build-arg $line"
            fi
          done <<< "${{ inputs.build_args }}"
        fi
        echo "args=$BUILD_ARGS" >> $GITHUB_OUTPUT
        
    - name: Prepare labels
      id: labels
      shell: bash
      run: |
        LABELS=""
        # é»˜è®¤æ ‡ç­¾
        LABELS="$LABELS --label org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        LABELS="$LABELS --label org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}"
        LABELS="$LABELS --label org.opencontainers.image.revision=${{ github.sha }}"
        
        # è‡ªå®šä¹‰æ ‡ç­¾
        if [[ -n "${{ inputs.labels }}" ]]; then
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              LABELS="$LABELS --label $line"
            fi
          done <<< "${{ inputs.labels }}"
        fi
        echo "labels=$LABELS" >> $GITHUB_OUTPUT
        
    - name: Generate image tags
      id: tags
      shell: bash
      run: |
        FULL_IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image_name }}"
        if [[ "${{ inputs.registry }}" == "docker.io" ]]; then
          FULL_IMAGE_NAME="${{ inputs.image_name }}"
        fi
        
        TAGS="$FULL_IMAGE_NAME:${{ inputs.tag }}"
        
        # å¦‚æœæ ‡ç­¾æ˜¯ latestï¼ŒåŒæ—¶æ·»åŠ  Git SHA æ ‡ç­¾
        if [[ "${{ inputs.tag }}" == "latest" ]]; then
          TAGS="$TAGS,$FULL_IMAGE_NAME:${{ github.sha }}"
        fi
        
        echo "tags=$TAGS" >> $GITHUB_OUTPUT
        echo "full_name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
        
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.push }}
        tags: ${{ steps.tags.outputs.tags }}
        cache-from: ${{ inputs.cache_from }}
        cache-to: ${{ inputs.cache_to }}
        build-args: |
          ${{ inputs.build_args }}
        labels: |
          org.opencontainers.image.created={{date 'YYYY-MM-DDTHH:mm:ssZ'}}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          ${{ inputs.labels }}
          
    - name: Get image info
      if: inputs.push == 'true'
      shell: bash
      run: |
        IMAGE_DIGEST="${{ steps.build.outputs.digest }}"
        IMAGE_URL="${{ steps.tags.outputs.full_name }}:${{ inputs.tag }}"
        
        # å°è¯•è·å–é•œåƒå¤§å°
        if command -v docker &> /dev/null; then
          IMAGE_SIZE=$(docker images --format "{{.Size}}" "$IMAGE_URL" 2>/dev/null | head -1 || echo "Unknown")
        else
          IMAGE_SIZE="Unknown"
        fi
        
        echo "image_digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT
        echo "image_url=$IMAGE_URL" >> $GITHUB_OUTPUT
        echo "image_size=$IMAGE_SIZE" >> $GITHUB_OUTPUT
        
    - name: Create summary
      shell: bash
      run: |
        echo "## ğŸ³ Docker é•œåƒæ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "- **é•œåƒåç§°**: ${{ steps.tags.outputs.full_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡ç­¾**: ${{ inputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: ${{ inputs.platforms }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ inputs.push }}" == "true" ]]; then
          echo "- **æ¨é€çŠ¶æ€**: âœ… å·²æ¨é€" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ‘˜è¦**: \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‹‰å–å‘½ä»¤**: \`docker pull ${{ steps.tags.outputs.full_name }}:${{ inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æ¨é€çŠ¶æ€**: â­ï¸ ä»…æ„å»º" >> $GITHUB_STEP_SUMMARY
        fi