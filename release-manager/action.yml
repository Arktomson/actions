name: 'Release Manager'
description: 'è‡ªåŠ¨åŒ–ç‰ˆæœ¬å‘å¸ƒç®¡ç†'
author: 'Arktomson'

branding:
  icon: 'tag'
  color: 'green'

inputs:
  tag_name:
    description: 'å‘å¸ƒæ ‡ç­¾åç§° (ä¾‹å¦‚: v1.0.0)'
    required: true
  release_name:
    description: 'å‘å¸ƒåç§° (å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ ‡ç­¾åç§°)'
    required: false
  body:
    description: 'å‘å¸ƒè¯´æ˜ (æ”¯æŒ Markdown)'
    required: false
  draft:
    description: 'æ˜¯å¦åˆ›å»ºè‰ç¨¿å‘å¸ƒ'
    required: false
    default: 'false'
  prerelease:
    description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
    required: false
    default: 'false'
  generate_notes:
    description: 'æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜'
    required: false
    default: 'true'
  target_commitish:
    description: 'ç›®æ ‡åˆ†æ”¯æˆ–æäº¤ (é»˜è®¤ä¸ºé»˜è®¤åˆ†æ”¯)'
    required: false
  files:
    description: 'è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªæ–‡ä»¶è·¯å¾„)'
    required: false
  token:
    description: 'GitHub Token (é»˜è®¤ä½¿ç”¨ GITHUB_TOKEN)'
    required: false
    default: ${{ github.token }}

outputs:
  release_id:
    description: 'åˆ›å»ºçš„å‘å¸ƒ ID'
  release_url:
    description: 'å‘å¸ƒé¡µé¢ URL'
  upload_url:
    description: 'æ–‡ä»¶ä¸Šä¼  URL'

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [[ ! "${{ inputs.tag_name }}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          echo "âš ï¸ æ ‡ç­¾åç§°æ ¼å¼å»ºè®®: v1.0.0"
        fi
        
    - name: Check if tag exists
      shell: bash
      run: |
        if git rev-parse "${{ inputs.tag_name }}" >/dev/null 2>&1; then
          echo "tag_exists=true" >> $GITHUB_ENV
        else
          echo "tag_exists=false" >> $GITHUB_ENV
        fi
        
    - name: Create tag if not exists
      if: env.tag_exists == 'false'
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if [[ -n "${{ inputs.target_commitish }}" ]]; then
          git tag -a "${{ inputs.tag_name }}" "${{ inputs.target_commitish }}" -m "Release ${{ inputs.tag_name }}"
        else
          git tag -a "${{ inputs.tag_name }}" -m "Release ${{ inputs.tag_name }}"
        fi
        
        git push origin "${{ inputs.tag_name }}"
        
    - name: Generate release notes
      if: inputs.generate_notes == 'true' && inputs.body == ''
      id: generate_notes
      shell: bash
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          echo "## ğŸš€ æ›´æ–°å†…å®¹" > release_notes.md
          echo "" >> release_notes.md
          
          # ç”Ÿæˆæäº¤æ—¥å¿—
          git log --pretty=format:"- %s (%an)" ${PREVIOUS_TAG}..${{ inputs.tag_name }} >> release_notes.md
          
          echo "" >> release_notes.md
          echo "## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯" >> release_notes.md
          echo "- **æäº¤æ•°é‡**: $(git rev-list --count ${PREVIOUS_TAG}..${{ inputs.tag_name }})" >> release_notes.md
          echo "- **æ–‡ä»¶å˜æ›´**: $(git diff --name-only ${PREVIOUS_TAG}..${{ inputs.tag_name }} | wc -l)" >> release_notes.md
        else
          echo "## ğŸ‰ é¦–æ¬¡å‘å¸ƒ" > release_notes.md
          echo "" >> release_notes.md
          echo "è¿™æ˜¯é¡¹ç›®çš„é¦–æ¬¡å‘å¸ƒç‰ˆæœ¬ã€‚" >> release_notes.md
        fi
        
        # è¯»å–ç”Ÿæˆçš„è¯´æ˜
        RELEASE_BODY=$(cat release_notes.md)
        echo "generated_body<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      with:
        tag_name: ${{ inputs.tag_name }}
        release_name: ${{ inputs.release_name || inputs.tag_name }}
        body: ${{ inputs.body || steps.generate_notes.outputs.generated_body }}
        draft: ${{ inputs.draft }}
        prerelease: ${{ inputs.prerelease }}
        commitish: ${{ inputs.target_commitish }}
        
    - name: Upload Release Assets
      if: inputs.files != ''
      shell: bash
      run: |
        while IFS= read -r file; do
          if [[ -f "$file" ]]; then
            echo "ä¸Šä¼ æ–‡ä»¶: $file"
            filename=$(basename "$file")
            curl -X POST \
              -H "Authorization: token ${{ inputs.token }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "${{ steps.create_release.outputs.upload_url }}?name=$filename"
          else
            echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
          fi
        done <<< "${{ inputs.files }}"
        
    - name: Output results
      shell: bash
      run: |
        echo "release_id=${{ steps.create_release.outputs.id }}" >> $GITHUB_OUTPUT
        echo "release_url=${{ steps.create_release.outputs.html_url }}" >> $GITHUB_OUTPUT
        echo "upload_url=${{ steps.create_release.outputs.upload_url }}" >> $GITHUB_OUTPUT
        
    - name: Create summary
      shell: bash
      run: |
        echo "## ğŸ‰ å‘å¸ƒåˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡ç­¾**: ${{ inputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åç§°**: ${{ inputs.release_name || inputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç±»å‹**: ${{ inputs.prerelease == 'true' && 'é¢„å‘å¸ƒ' || 'æ­£å¼å‘å¸ƒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **çŠ¶æ€**: ${{ inputs.draft == 'true' && 'è‰ç¨¿' || 'å·²å‘å¸ƒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é“¾æ¥**: [${{ inputs.tag_name }}](${{ steps.create_release.outputs.html_url }})" >> $GITHUB_STEP_SUMMARY