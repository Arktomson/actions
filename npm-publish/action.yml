name: 'NPM Publisher'
description: 'å‘å¸ƒ NPM åŒ…åˆ°æ³¨å†Œè¡¨'

branding:
  icon: 'package'
  color: 'blue'

inputs:
  version:
    description: 'ç‰ˆæœ¬æ›´æ–°ç±»åž‹ (patch, minor, major) æˆ–å…·ä½“ç‰ˆæœ¬å·'
    required: false
    default: 'patch'
  registry:
    description: 'NPM æ³¨å†Œè¡¨ URL'
    required: false
    default: 'https://registry.npmjs.org/'
  token:
    description: 'NPM è®¿é—®ä»¤ç‰Œ'
    required: true
  package_path:
    description: 'package.json æ–‡ä»¶è·¯å¾„'
    required: false
    default: './package.json'
  dist_tag:
    description: 'å‘å¸ƒæ ‡ç­¾ (latest, beta, alpha, etc.)'
    required: false
    default: 'latest'
  access:
    description: 'åŒ…è®¿é—®çº§åˆ« (public, restricted)'
    required: false
    default: 'public'
  skip_build:
    description: 'æ˜¯å¦è·³è¿‡æž„å»ºæ­¥éª¤'
    required: false
    default: 'false'
  build_script:
    description: 'æž„å»ºè„šæœ¬å‘½ä»¤'
    required: false
    default: 'npm run build'

outputs:
  published_version:
    description: 'å·²å‘å¸ƒçš„ç‰ˆæœ¬å·'
  package_name:
    description: 'åŒ…åç§°'
  registry_url:
    description: 'æ³¨å†Œè¡¨ URL'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: ${{ inputs.registry }}
        
    - name: Get package info
      id: package
      shell: bash
      run: |
        PACKAGE_NAME=$(node -p "require('${{ inputs.package_path }}').name")
        CURRENT_VERSION=$(node -p "require('${{ inputs.package_path }}').version")
        
        echo "name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
        echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
        
    - name: Install dependencies
      shell: bash
      run: npm ci
      
    - name: Run build
      if: inputs.skip_build == 'false'
      shell: bash
      run: ${{ inputs.build_script }}
      
    - name: Update version
      id: version
      shell: bash
      run: |
        if [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
          # å…·ä½“ç‰ˆæœ¬å·
          npm version ${{ inputs.version }} --no-git-tag-version
          NEW_VERSION="${{ inputs.version }}"
        else
          # ç‰ˆæœ¬ç±»åž‹ (patch, minor, major)
          NEW_VERSION=$(npm version ${{ inputs.version }} --no-git-tag-version)
          NEW_VERSION=${NEW_VERSION#v}  # ç§»é™¤ v å‰ç¼€
        fi
        
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        
    - name: Run tests
      shell: bash
      run: |
        if npm run test --if-present; then
          echo "âœ… æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•è„šæœ¬æˆ–æµ‹è¯•å¤±è´¥"
        fi
        
    - name: Publish to NPM
      shell: bash
      env:
        NODE_AUTH_TOKEN: ${{ inputs.token }}
      run: |
        if [[ "${{ inputs.access }}" == "public" ]]; then
          npm publish --access public --tag ${{ inputs.dist_tag }}
        else
          npm publish --tag ${{ inputs.dist_tag }}
        fi
        
        echo "published_version=${{ steps.version.outputs.new_version }}" >> $GITHUB_OUTPUT
        echo "package_name=${{ steps.package.outputs.name }}" >> $GITHUB_OUTPUT
        echo "registry_url=${{ inputs.registry }}" >> $GITHUB_OUTPUT
        
    - name: Create summary
      shell: bash
      run: |
        echo "## ðŸ“¦ NPM å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- **åŒ…åç§°**: ${{ steps.package.outputs.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡ç­¾**: ${{ inputs.dist_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ³¨å†Œè¡¨**: ${{ inputs.registry }}" >> $GITHUB_STEP_SUMMARY
        echo "- **NPM é“¾æŽ¥**: https://www.npmjs.com/package/${{ steps.package.outputs.name }}" >> $GITHUB_STEP_SUMMARY