name: 'Code Quality Checker'
description: 'å…¨é¢çš„ä»£ç è´¨é‡æ£€æŸ¥å·¥å…· - åŒ…å« Lintã€æµ‹è¯•ã€ç±»å‹æ£€æŸ¥å’Œå®‰å…¨å®¡è®¡'
author: 'Arktomson'

branding:
  icon: 'check-circle'
  color: 'green'

inputs:
  node_version:
    description: 'Node.js ç‰ˆæœ¬'
    required: false
    default: '18'
  package_path:
    description: 'package.json æ–‡ä»¶è·¯å¾„'
    required: false
    default: './package.json'
  enable_lint:
    description: 'å¯ç”¨ä»£ç æ£€æŸ¥ (ESLint/Prettier)'
    required: false
    default: 'true'
  enable_test:
    description: 'å¯ç”¨æµ‹è¯•'
    required: false
    default: 'true'
  enable_typecheck:
    description: 'å¯ç”¨ç±»å‹æ£€æŸ¥ (TypeScript)'
    required: false
    default: 'true'
  enable_audit:
    description: 'å¯ç”¨å®‰å…¨å®¡è®¡'
    required: false
    default: 'true'
  enable_coverage:
    description: 'å¯ç”¨ä»£ç è¦†ç›–ç‡æ£€æŸ¥'
    required: false
    default: 'true'
  coverage_threshold:
    description: 'æœ€ä½ä»£ç è¦†ç›–ç‡é˜ˆå€¼ (%)'
    required: false
    default: '80'
  working_directory:
    description: 'å·¥ä½œç›®å½•'
    required: false
    default: '.'
  fail_on_error:
    description: 'å½“æ£€æŸ¥å¤±è´¥æ—¶æ˜¯å¦ä½¿ Action å¤±è´¥'
    required: false
    default: 'true'
  custom_lint_command:
    description: 'è‡ªå®šä¹‰ Lint å‘½ä»¤'
    required: false
  custom_test_command:
    description: 'è‡ªå®šä¹‰æµ‹è¯•å‘½ä»¤'
    required: false
  custom_typecheck_command:
    description: 'è‡ªå®šä¹‰ç±»å‹æ£€æŸ¥å‘½ä»¤'
    required: false

outputs:
  lint_result:
    description: 'Lint æ£€æŸ¥ç»“æœ (success/failure)'
  test_result:
    description: 'æµ‹è¯•ç»“æœ (success/failure)'
  typecheck_result:
    description: 'ç±»å‹æ£€æŸ¥ç»“æœ (success/failure)'
  audit_result:
    description: 'å®‰å…¨å®¡è®¡ç»“æœ (success/failure)'
  coverage_result:
    description: 'ä»£ç è¦†ç›–ç‡ç»“æœ (success/failure)'
  coverage_percentage:
    description: 'ä»£ç è¦†ç›–ç‡ç™¾åˆ†æ¯”'
  total_score:
    description: 'æ€»ä½“è´¨é‡å¾—åˆ† (0-100)'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
        cache: 'npm'
        cache-dependency-path: ${{ inputs.package_path }}
        
    - name: æ£€æŸ¥é¡¹ç›®é…ç½®
      id: check_config
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®é…ç½®..."
        
        # æ£€æŸ¥ package.json æ˜¯å¦å­˜åœ¨
        if [[ ! -f "${{ inputs.package_path }}" ]]; then
          echo "âŒ package.json æ–‡ä»¶ä¸å­˜åœ¨: ${{ inputs.package_path }}"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦ä¸º TypeScript é¡¹ç›®
        HAS_TYPESCRIPT="false"
        if [[ -f "tsconfig.json" ]] || grep -q '"typescript"' "${{ inputs.package_path }}"; then
          HAS_TYPESCRIPT="true"
        fi
        echo "has_typescript=$HAS_TYPESCRIPT" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æµ‹è¯•è„šæœ¬
        HAS_TEST_SCRIPT="false"
        if grep -q '"test"' "${{ inputs.package_path }}"; then
          HAS_TEST_SCRIPT="true"
        fi
        echo "has_test_script=$HAS_TEST_SCRIPT" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ lint è„šæœ¬
        HAS_LINT_SCRIPT="false"
        if grep -q '"lint"' "${{ inputs.package_path }}"; then
          HAS_LINT_SCRIPT="true"
        fi
        echo "has_lint_script=$HAS_LINT_SCRIPT" >> $GITHUB_OUTPUT
        
        echo "âœ… é¡¹ç›®é…ç½®æ£€æŸ¥å®Œæˆ"
        echo "- TypeScript: $HAS_TYPESCRIPT"
        echo "- æµ‹è¯•è„šæœ¬: $HAS_TEST_SCRIPT"
        echo "- Lint è„šæœ¬: $HAS_LINT_SCRIPT"
        
    - name: å®‰è£…ä¾èµ–
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        
        if [[ -f "package-lock.json" ]]; then
          npm ci
        elif [[ -f "yarn.lock" ]]; then
          yarn install --frozen-lockfile
        elif [[ -f "pnpm-lock.yaml" ]]; then
          npx pnpm install --frozen-lockfile
        else
          npm install
        fi
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ä»£ç  Lint æ£€æŸ¥
      if: inputs.enable_lint == 'true'
      id: lint
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ” å¼€å§‹ Lint æ£€æŸ¥..."
        
        LINT_RESULT="success"
        
        if [[ -n "${{ inputs.custom_lint_command }}" ]]; then
          echo "ä½¿ç”¨è‡ªå®šä¹‰ Lint å‘½ä»¤: ${{ inputs.custom_lint_command }}"
          if ! ${{ inputs.custom_lint_command }}; then
            LINT_RESULT="failure"
          fi
        elif [[ "${{ steps.check_config.outputs.has_lint_script }}" == "true" ]]; then
          echo "ä½¿ç”¨é¡¹ç›® Lint è„šæœ¬..."
          if ! npm run lint; then
            LINT_RESULT="failure"
          fi
        else
          echo "å°è¯•ä½¿ç”¨ ESLint..."
          if command -v npx eslint &> /dev/null; then
            if ! npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0; then
              LINT_RESULT="failure"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° ESLint é…ç½®ï¼Œè·³è¿‡ Lint æ£€æŸ¥"
            LINT_RESULT="skipped"
          fi
        fi
        
        echo "lint_result=$LINT_RESULT" >> $GITHUB_OUTPUT
        
        if [[ "$LINT_RESULT" == "success" ]]; then
          echo "âœ… Lint æ£€æŸ¥é€šè¿‡"
        elif [[ "$LINT_RESULT" == "failure" ]]; then
          echo "âŒ Lint æ£€æŸ¥å¤±è´¥"
          if [[ "${{ inputs.fail_on_error }}" == "true" ]]; then
            exit 1
          fi
        fi
        
    - name: è¿è¡Œæµ‹è¯•
      if: inputs.enable_test == 'true'
      id: test
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ§ª å¼€å§‹è¿è¡Œæµ‹è¯•..."
        
        TEST_RESULT="success"
        COVERAGE_PERCENTAGE="0"
        
        if [[ -n "${{ inputs.custom_test_command }}" ]]; then
          echo "ä½¿ç”¨è‡ªå®šä¹‰æµ‹è¯•å‘½ä»¤: ${{ inputs.custom_test_command }}"
          if ! ${{ inputs.custom_test_command }}; then
            TEST_RESULT="failure"
          fi
        elif [[ "${{ steps.check_config.outputs.has_test_script }}" == "true" ]]; then
          echo "ä½¿ç”¨é¡¹ç›®æµ‹è¯•è„šæœ¬..."
          if [[ "${{ inputs.enable_coverage }}" == "true" ]]; then
            # å°è¯•è¿è¡Œå¸¦è¦†ç›–ç‡çš„æµ‹è¯•
            if npm run test -- --coverage || npm run test:coverage 2>/dev/null; then
              echo "âœ… æµ‹è¯•è¿è¡ŒæˆåŠŸ (å¸¦è¦†ç›–ç‡)"
              
              # å°è¯•è¯»å–è¦†ç›–ç‡ä¿¡æ¯
              if [[ -f "coverage/lcov-report/index.html" ]]; then
                COVERAGE_PERCENTAGE=$(grep -o '[0-9]\+\.[0-9]\+%' coverage/lcov-report/index.html | head -1 | sed 's/%//' || echo "0")
              elif [[ -f "coverage/coverage-summary.json" ]]; then
                COVERAGE_PERCENTAGE=$(node -p "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct" 2>/dev/null || echo "0")
              fi
            elif npm run test; then
              echo "âœ… æµ‹è¯•è¿è¡ŒæˆåŠŸ (æ— è¦†ç›–ç‡)"
            else
              TEST_RESULT="failure"
            fi
          else
            if ! npm run test; then
              TEST_RESULT="failure"
            fi
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•"
          TEST_RESULT="skipped"
        fi
        
        echo "test_result=$TEST_RESULT" >> $GITHUB_OUTPUT
        echo "coverage_percentage=$COVERAGE_PERCENTAGE" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
        COVERAGE_RESULT="success"
        if [[ "${{ inputs.enable_coverage }}" == "true" ]] && [[ "$TEST_RESULT" == "success" ]]; then
          if (( $(echo "$COVERAGE_PERCENTAGE >= ${{ inputs.coverage_threshold }}" | bc -l) )); then
            echo "âœ… ä»£ç è¦†ç›–ç‡: ${COVERAGE_PERCENTAGE}% (é˜ˆå€¼: ${{ inputs.coverage_threshold }}%)"
          else
            echo "âŒ ä»£ç è¦†ç›–ç‡ä¸è¶³: ${COVERAGE_PERCENTAGE}% < ${{ inputs.coverage_threshold }}%"
            COVERAGE_RESULT="failure"
            if [[ "${{ inputs.fail_on_error }}" == "true" ]]; then
              exit 1
            fi
          fi
        fi
        echo "coverage_result=$COVERAGE_RESULT" >> $GITHUB_OUTPUT
        
        if [[ "$TEST_RESULT" == "failure" ]]; then
          echo "âŒ æµ‹è¯•å¤±è´¥"
          if [[ "${{ inputs.fail_on_error }}" == "true" ]]; then
            exit 1
          fi
        fi
        
    - name: TypeScript ç±»å‹æ£€æŸ¥
      if: inputs.enable_typecheck == 'true' && steps.check_config.outputs.has_typescript == 'true'
      id: typecheck
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ”§ å¼€å§‹ TypeScript ç±»å‹æ£€æŸ¥..."
        
        TYPECHECK_RESULT="success"
        
        if [[ -n "${{ inputs.custom_typecheck_command }}" ]]; then
          echo "ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹æ£€æŸ¥å‘½ä»¤: ${{ inputs.custom_typecheck_command }}"
          if ! ${{ inputs.custom_typecheck_command }}; then
            TYPECHECK_RESULT="failure"
          fi
        elif grep -q '"typecheck"' "${{ inputs.package_path }}"; then
          echo "ä½¿ç”¨é¡¹ç›®ç±»å‹æ£€æŸ¥è„šæœ¬..."
          if ! npm run typecheck; then
            TYPECHECK_RESULT="failure"
          fi
        else
          echo "ä½¿ç”¨ tsc è¿›è¡Œç±»å‹æ£€æŸ¥..."
          if ! npx tsc --noEmit; then
            TYPECHECK_RESULT="failure"
          fi
        fi
        
        echo "typecheck_result=$TYPECHECK_RESULT" >> $GITHUB_OUTPUT
        
        if [[ "$TYPECHECK_RESULT" == "success" ]]; then
          echo "âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥"
          if [[ "${{ inputs.fail_on_error }}" == "true" ]]; then
            exit 1
          fi
        fi
        
    - name: å®‰å…¨å®¡è®¡
      if: inputs.enable_audit == 'true'
      id: audit
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        echo "ğŸ”’ å¼€å§‹å®‰å…¨å®¡è®¡..."
        
        AUDIT_RESULT="success"
        
        # NPM å®¡è®¡
        echo "è¿è¡Œ npm audit..."
        if ! npm audit --audit-level=moderate; then
          echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´"
          
          # å°è¯•è‡ªåŠ¨ä¿®å¤
          echo "å°è¯•è‡ªåŠ¨ä¿®å¤..."
          if npm audit fix; then
            echo "âœ… éƒ¨åˆ†æ¼æ´å·²è‡ªåŠ¨ä¿®å¤"
            # å†æ¬¡æ£€æŸ¥
            if ! npm audit --audit-level=moderate; then
              AUDIT_RESULT="failure"
            fi
          else
            AUDIT_RESULT="failure"
          fi
        fi
        
        # å¦‚æœæœ‰ Yarnï¼Œä¹Ÿè¿è¡Œ Yarn å®¡è®¡
        if [[ -f "yarn.lock" ]] && command -v yarn &> /dev/null; then
          echo "è¿è¡Œ yarn audit..."
          if ! yarn audit --level moderate; then
            AUDIT_RESULT="failure"
          fi
        fi
        
        echo "audit_result=$AUDIT_RESULT" >> $GITHUB_OUTPUT
        
        if [[ "$AUDIT_RESULT" == "success" ]]; then
          echo "âœ… å®‰å…¨å®¡è®¡é€šè¿‡"
        else
          echo "âŒ å®‰å…¨å®¡è®¡å‘ç°é—®é¢˜"
          if [[ "${{ inputs.fail_on_error }}" == "true" ]]; then
            exit 1
          fi
        fi
        
    - name: è®¡ç®—è´¨é‡å¾—åˆ†
      id: score
      shell: bash
      run: |
        echo "ğŸ“Š è®¡ç®—ä»£ç è´¨é‡å¾—åˆ†..."
        
        TOTAL_SCORE=0
        TOTAL_CHECKS=0
        
        # Lint æ£€æŸ¥
        if [[ "${{ inputs.enable_lint }}" == "true" ]]; then
          TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
          if [[ "${{ steps.lint.outputs.lint_result }}" == "success" ]]; then
            TOTAL_SCORE=$((TOTAL_SCORE + 25))
          fi
        fi
        
        # æµ‹è¯•æ£€æŸ¥
        if [[ "${{ inputs.enable_test }}" == "true" ]]; then
          TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
          if [[ "${{ steps.test.outputs.test_result }}" == "success" ]]; then
            TOTAL_SCORE=$((TOTAL_SCORE + 25))
          fi
        fi
        
        # ç±»å‹æ£€æŸ¥
        if [[ "${{ inputs.enable_typecheck }}" == "true" ]] && [[ "${{ steps.check_config.outputs.has_typescript }}" == "true" ]]; then
          TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
          if [[ "${{ steps.typecheck.outputs.typecheck_result }}" == "success" ]]; then
            TOTAL_SCORE=$((TOTAL_SCORE + 25))
          fi
        fi
        
        # å®‰å…¨å®¡è®¡
        if [[ "${{ inputs.enable_audit }}" == "true" ]]; then
          TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
          if [[ "${{ steps.audit.outputs.audit_result }}" == "success" ]]; then
            TOTAL_SCORE=$((TOTAL_SCORE + 25))
          fi
        fi
        
        # è®¡ç®—æœ€ç»ˆå¾—åˆ† (0-100)
        if [[ $TOTAL_CHECKS -gt 0 ]]; then
          FINAL_SCORE=$((TOTAL_SCORE * 100 / (TOTAL_CHECKS * 25)))
        else
          FINAL_SCORE=0
        fi
        
        echo "total_score=$FINAL_SCORE" >> $GITHUB_OUTPUT
        echo "ğŸ“Š ä»£ç è´¨é‡å¾—åˆ†: $FINAL_SCORE/100"
        
    - name: åˆ›å»ºè´¨é‡æŠ¥å‘Š
      shell: bash
      run: |
        echo "## ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ æ€»ä½“å¾—åˆ†: ${{ steps.score.outputs.total_score }}/100" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Lint æ£€æŸ¥ç»“æœ
        if [[ "${{ inputs.enable_lint }}" == "true" ]]; then
          if [[ "${{ steps.lint.outputs.lint_result }}" == "success" ]]; then
            echo "- âœ… **ä»£ç é£æ ¼æ£€æŸ¥**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.lint.outputs.lint_result }}" == "failure" ]]; then
            echo "- âŒ **ä»£ç é£æ ¼æ£€æŸ¥**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ **ä»£ç é£æ ¼æ£€æŸ¥**: è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # æµ‹è¯•ç»“æœ
        if [[ "${{ inputs.enable_test }}" == "true" ]]; then
          if [[ "${{ steps.test.outputs.test_result }}" == "success" ]]; then
            echo "- âœ… **å•å…ƒæµ‹è¯•**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ inputs.enable_coverage }}" == "true" ]] && [[ -n "${{ steps.test.outputs.coverage_percentage }}" ]]; then
              echo "  - ä»£ç è¦†ç›–ç‡: ${{ steps.test.outputs.coverage_percentage }}%" >> $GITHUB_STEP_SUMMARY
            fi
          elif [[ "${{ steps.test.outputs.test_result }}" == "failure" ]]; then
            echo "- âŒ **å•å…ƒæµ‹è¯•**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ **å•å…ƒæµ‹è¯•**: è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # ç±»å‹æ£€æŸ¥ç»“æœ
        if [[ "${{ inputs.enable_typecheck }}" == "true" ]] && [[ "${{ steps.check_config.outputs.has_typescript }}" == "true" ]]; then
          if [[ "${{ steps.typecheck.outputs.typecheck_result }}" == "success" ]]; then
            echo "- âœ… **ç±»å‹æ£€æŸ¥**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **ç±»å‹æ£€æŸ¥**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # å®‰å…¨å®¡è®¡ç»“æœ
        if [[ "${{ inputs.enable_audit }}" == "true" ]]; then
          if [[ "${{ steps.audit.outputs.audit_result }}" == "success" ]]; then
            echo "- âœ… **å®‰å…¨å®¡è®¡**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **å®‰å…¨å®¡è®¡**: å‘ç°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš™ï¸ é…ç½®ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.js ç‰ˆæœ¬**: ${{ inputs.node_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å·¥ä½œç›®å½•**: ${{ inputs.working_directory }}" >> $GITHUB_STEP_SUMMARY
        echo "- **TypeScript é¡¹ç›®**: ${{ steps.check_config.outputs.has_typescript == 'true' && 'æ˜¯' || 'å¦' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤±è´¥æ—¶é€€å‡º**: ${{ inputs.fail_on_error == 'true' && 'æ˜¯' || 'å¦' }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ inputs.enable_coverage }}" == "true" ]]; then
          echo "- **è¦†ç›–ç‡é˜ˆå€¼**: ${{ inputs.coverage_threshold }}%" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æŠ¥å‘Šæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY